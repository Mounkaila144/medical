<VirtualHost *:80>
    ServerName medical.ptrniger.com
    RewriteEngine On
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName medical.ptrniger.com

    SSLEngine on
    SSLCertificateFile    /etc/letsencrypt/live/ptrniger.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/ptrniger.com/privkey.pem
    Include               /etc/letsencrypt/options-ssl-apache.conf

    ProxyPreserveHost On
    ProxyRequests    Off

    # Headers de sécurité
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Configuration pour les WebSockets (GraphQL subscriptions, Socket.io)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule ^/api/(.*)     ws://127.0.0.1:3001/$1 [P,L]
    RewriteRule ^/socket.io/(.*) ws://127.0.0.1:3001/socket.io/$1 [P,L]

    # Proxy vers le backend NestJS (toutes les requêtes /api/*)
    ProxyPass        /api http://127.0.0.1:3001 nocanon
    ProxyPassReverse /api http://127.0.0.1:3001

    # Endpoint health check backend
    ProxyPass        /health http://127.0.0.1:3001/health nocanon
    ProxyPassReverse /health http://127.0.0.1:3001/health

    # GraphQL endpoint
    ProxyPass        /graphql http://127.0.0.1:3001/graphql nocanon
    ProxyPassReverse /graphql http://127.0.0.1:3001/graphql

    # Configuration pour les uploads de gros fichiers (50MB)
    LimitRequestBody 52428800

    # Proxy vers le frontend Next.js (toutes les autres requêtes)
    ProxyPass        / http://127.0.0.1:3002/ nocanon
    ProxyPassReverse / http://127.0.0.1:3002/

    # Support des WebSockets pour Next.js HMR (si en dev)
    ProxyPass        /_next/webpack-hmr ws://127.0.0.1:3002/_next/webpack-hmr
    ProxyPassReverse /_next/webpack-hmr ws://127.0.0.1:3002/_next/webpack-hmr

    <Location />
      Require all granted
    </Location>

    # Logs spécifiques
    LogLevel info
    ErrorLog   ${APACHE_LOG_DIR}/medical-error.log
    CustomLog  ${APACHE_LOG_DIR}/medical-access.log combined
</VirtualHost> root@box:/etc/apache2/sites-available#